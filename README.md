
# m3DinAI

Custom Python scripts used in the paper **“Label-free morphological profiling of chemotherapy response in 3D breast cancer spheroids”**.  
The pipeline implements brightfield HCI preprocessing, segmentation, feature extraction (morphology, texture, and radiomics), dimensionality reduction, clustering, and basic statistics for TNBC spheroids.

> **Python**: 3.10  
> **Key libs**: OpenCV, NumPy, scikit-image, Mahotas, PyRadiomics, SimpleITK, scikit-learn, UMAP, matplotlib, seaborn.

---

## Repository structure

```
m3DinAI/
├── src/
│   ├── 1_feature_extraction.py
│   ├── 2_copy_excels.py
│   ├── 3_label_treatments.py
│   ├── 4_superclustering_individuals.py
│   ├── 5_superclustering_combined.py
│   ├── 6_violin_plots.py
│   ├── 7_variability_replicates.py
│   └── 8_welch_bonferroni.py
├── notebooks/                 # optional example notebooks
├── data/                      # empty (see 'Data layout')
├── results/                   # figures/tables generated by scripts
├── requirements.txt
├── LICENSE
└── CITATION.cff
```

---

## Installation

```bash
git clone https://github.com/InmaIG/m3DinAI.git
cd m3DinAI

# (optional but recommended)
python -m venv .venv
# Linux/Mac:
source .venv/bin/activate
# Windows:
# .venv\Scripts\activate

pip install -r requirements.txt
```

---

## Demo (synthetic data)

A minimal, self-contained demo notebook is provided in **`notebooks/m3DinAI_demo.ipynb`**.  
It does **not** require real images: it generates a small synthetic feature table, runs a 2D UMAP, and performs a simple Welch’s t-test vs DMSO.

### How to run
```bash
# Create and activate the environment (if you haven't)
python -m venv .venv
# Linux/Mac:
source .venv/bin/activate
# Windows:
# .venv\Scripts\activate

pip install -r requirements.txt

# Install Jupyter and launch the demo
python -m pip install jupyter
jupyter notebook notebooks/m3DinAI_demo.ipynb
```

### What the demo does
- Creates a toy table `results/demo/demo_spheroid_features_trat.xlsx` with features and `Treatment` labels.
- Standardizes features and computes a **UMAP** embedding.
- Plots a scatter colored by treatment.
- Runs a **Welch’s t-test** (unequal variances) vs **DMSO** on a toy feature and saves:
  - `results/demo/welch_summary_demo.csv`

### Expected outputs
- A UMAP figure displayed in the notebook.
- Files written under `results/demo/`.

> For real experiments, run the scripts under `src/` on your imaging data and adjust paths (e.g., `root_dir`, `excel_folder`, `results_folder`) as described below.

### Troubleshooting
- **`ModuleNotFoundError`** → ensure the virtual environment is active and `pip install -r requirements.txt` completed without errors.
- **`umap-learn` issues** on some systems → try `pip install umap-learn==0.5.3`.
- **Notebook doesn’t open** → install Jupyter with `python -m pip install jupyter` and relaunch.
- **No outputs in `results/demo/`** → verify you have write permissions in the repository folder.

---

## Data layout

Raw images are **not** included in this repository. The scripts expect a directory tree per the Methods in the paper (72H/96H/120H × R1/R2/R3 × cell lines):

```
<ROOT_DATA>/
├── 72H/
│   ├── R1/
│   │   ├── BT549_.../
│   │   │   └── Images/            # TIFF Z-stacks
│   │   ├── HCC1806_.../
│   │   └── MDA468_.../
│   └── R2/ ...
├── 96H/ ...
└── 120H/ ...
```

> If your data live elsewhere or use different names, **edit the configurable paths** inside each script (look for variables like `root_dir`, `excel_folder`, `results_folder`, etc.).

---

## Pipeline (run in order)

1) **Feature extraction** — `src/1_feature_extraction.py`  
   - Builds **maximum intensity projections** from 16-bit Z-stacks.
   - Converts projections to **8-bit** with percentile clipping.
   - Segments spheroids (Gaussian → Otsu → morphology) and draws contours.
   - Selects largest object per well and extracts:
     - geometric (area, perimeter, circularity, solidity, extent, axes, Hu moments),
     - texture (GLCM, LBP, Haralick),
     - **radiomics** (PyRadiomics on SimpleITK image+mask).
   - Saves `spheroid_features.xlsx` per experiment folder.
   - **Configure**: `root_dir` and per-folder output paths inside the script.

2) **Collect Excel files** — `src/2_copy_excels.py`  
   - Copies all `spheroid_features.xlsx` into a single folder named `EXCELS esferas_completo`.
   - **Configure**: `carpeta_raiz` (root of the experiment tree).

3) **Label treatments** — `src/3_label_treatments.py`  
   - Adds a `Treatment` column based on the column number parsed from `Filename` (regex `c##`).
   - Mapping (default): `DMSO (1–3)`, `Anthracyclines (4–9)`, `Topoisomerase inhibitor (10–15)`, `Taxane (16–21)`, `MMS (22–24)`.
   - Writes `*_trat.xlsx` into `Excels etiquetados`.

4) **UMAP per replicate** — `src/4_superclustering_individuals.py`  
   - Per file: outlier filtering **within treatment** (median ± 3·SD), z-score standardization, UMAP (n_neighbors=15, min_dist=0.1), and (optional) hierarchical clustering.
   - Saves UMAP scatter plots to `RESULTADOS_GRAFICAS` with fixed treatment colors.

5) **UMAP combined (per cell line)** — `src/5_superclustering_combined.py`  
   - Concatenates the 9 files for a given line (3 timepoints × 3 replicates), applies the same filtering + UMAP, and draws a **joint** plot.
   - Marker encodes replicate, color encodes treatment. Output in `RESULTADOS_GRAFICAS_COMBINED_LINE`.

6) **Violin plots** — `src/6_violin_plots.py`  
   - Normalizes selected features (MinMax) and plots distributions across lines.

7) **Replicate variability** — `src/7_variability_replicates.py`  
   - Histograms per feature comparing R1/R2/R3 for each line.

8) **Welch t-tests + Bonferroni** — `src/8_welch_bonferroni.py`  
   - Consumes aggregated CSVs (`*_variation_summary.csv`) and performs **Welch** t-tests vs **DMSO** with Bonferroni correction.
   - Overlays significance stars (ns, *, **, ***, ****) on barplots.

---

## Notes & tips

- **Reproducibility**: versions pinned where reported in the paper. Radiomics can be sensitive to pre-processing; keep SimpleITK datatypes consistent.
- **Performance**: MIP and feature extraction can be I/O-bound; running on SSD and using fewer concurrent jobs reduces disk contention.
- **Quality control**: check contour overlays exported in `Images/4. Spheroids` for segmentation accuracy before downstream analysis.

---

## Citation

If you use this software, please cite both the paper and the archived code release:

[![DOI](https://zenodo.org/badge/DOI/10.5281/zenodo.NEW_DOI.svg)](https://doi.org/10.5281/zenodo.NEW_DOI)

```
@software{m3dinai_zenodo_2025,
title = {m3DinAI: Morphometric profiling pipeline for 3D TNBC spheroids},
author = {Iáñez García, Inmaculada},
year = {2025},
publisher = {Zenodo},
version = {v1.0.2},
doi = {10.5281/zenodo.NEW_DOI},
url = {https://github.com/InmaIG/m3DinAI}
}
```

Archived at Zenodo: https://doi.org/10.5281/zenodo.NEW_DOI  
Latest version: https://doi.org/10.5281/zenodo.17325450

---

## License

This repository is distributed under the terms of the **MIT License**. See the file `LICENSE` for details.
